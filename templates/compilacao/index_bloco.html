{% load i18n %}
{% load compilacao_filters %}

{% for dpt in object_list %}
	{% if dpt.nivel == view.flag_nivel_old %}
			</div>
		{% elif dpt.nivel < view.flag_nivel_old %}
			{% close_div view.flag_nivel_old dpt.nivel 0 %}
	{% endif%}


	{% if forloop.first and view|isinst:'DispositivoView' %}
	{% else %}
		<div class="dpt {%if dpt.tipo_dispositivo.class_css == 'bloco_alteracao'%}bloco_alteracao{%endif%}">
	{% endif%}

	{% spaceless %}
	<div class="{{ dpt.tipo_dispositivo.class_css }}">
		<div class="dptt {% dispositivo_desativado dpt view.inicio_vigencia view.fim_vigencia %}">
			{{ dpt.tipo_dispositivo.rotulo_prefixo_html|safe }}<a name="{{dpt.pk}}" title="{{dpt.pk}}">{{ dpt.rotulo }}</a>{{ dpt.tipo_dispositivo.rotulo_sufixo_html|safe }}{{ dpt.tipo_dispositivo.texto_prefixo_html|safe }}{%if dpt.texto%}{{ dpt.texto|safe }}{%else%}&nbsp;{%endif%}
			{% if dpt.norma_publicada_id != None and not dpt.tipo_dispositivo.dispositivo_de_articulacao %}
				<a class="link_alterador" href="{%url 'compilacao' dpt.norma_publicada.pk %}#{{dpt.dispositivo_atualizador_id}}">
					{{ dpt.tipo_dispositivo.nota_automatica_prefixo_html|safe }}
					{% nota_automatica dpt %}
					{{ dpt.tipo_dispositivo.nota_automatica_sufixo_html|safe }}
				</a>
			{% endif %}
			{% if user.is_authenticated and not dpt.tipo_dispositivo.dispositivo_de_articulacao%}
				{% if perms.compilacao.add_nota or perms.compilacao.add_vide %}
		            <div class="dne" id="dne{{dpt.pk}}" pk="{{dpt.pk}}">{# TODO: User - dne - Dispostivo Nota Editor -  tratar permissão de usuário#}
		                <ul class="btns-action">
			                {% if perms.compilacao.add_nota %}<li><a class="btn-action btn-nota-create"  model="nota" pk="{{dpt.pk}}" title="{% trans 'Adcionar Nota'%}">&nbsp;</a></li>{% endif %}
							{% if perms.compilacao.add_vide %}<li><a class="btn-action btn-vide-create" model="vide"  pk="{{dpt.pk}}" title="{% trans 'Adcionar Vide'%}">V</a></li>{% endif %}
		                </ul>
						<div class="dne-form"></div>
		            </div>
				 {% endif %}
			{% endif%}
		</div>

		{% if not dpt.tipo_dispositivo.dispositivo_de_articulacao%}
			<div class="dn" id="dn{{dpt.pk}}" pk="{{dpt.pk}}">{# Dispostivo Nota e Vides #}
						<ul class="dnl">{# Dispostivo Nota Lista#}
							{% if cita and dpt.pk in cita %}
								{% for vide in dpt.cita.all %}
									{%if not forloop.first %}<li class="bullet">&#8226;</li>{%endif%}
									<li class="dnli" id="nt{{vide.pk}}">

											<ul>
												{% if user.is_authenticated %}
													{% if perms.compilacao.change_vide %}
														<li><a class="btn-action btn-vide-edit" model="vide" pk="{{vide.pk}}">Editar</a></li>
														<li class="bullet">&#8226;</li>
													{%endif%}
													{% if perms.compilacao.delete_vide %}
														<li><a class="btn-action btn-vide-delete" model="vide" pk="{{vide.pk}}">Excluir</a></li>
														<li class="bullet">&#8226;</li>
													{%endif%}
												{% endif %}
												<li class="ntipo">{{vide.tipo.nome}}</li>
												<li class="bullet">&#8226;</li>
												 <li class="npublicacao" title="{% trans 'Data de Criação'%}">{{vide.created|date:"d M Y"}}</li>
											</ul>
										<div class="ntitulo">Vide: </div>
										<div class="ntexto">
											{% if dpt.is_relative_auto_insert %}
												<a href="{%url 'compilacao' vide.dispositivo_ref.dispositivo_pai.norma.pk%}#{{vide.dispositivo_ref.dispositivo_pai.pk }}">{{ vide.dispositivo_ref.dispositivo_pai}}</a>
											{% else %}
												<a href="{%url 'compilacao' vide.dispositivo_ref.norma.pk%}#{{vide.dispositivo_ref.pk }}">{{ vide.dispositivo_ref}}</a>
											{% endif %}
											{% if vide.texto %} - {{vide.texto}}{% endif %}
										</div>
									</li>
								{% endfor %}
							{% endif %}

							{% if citado and dpt.pk in citado %}
								{% for vide in dpt.citado.all %}
									{%if not forloop.first %}<li class="bullet">&#8226;</li>{%endif%}
									<li class="dnli" id="nt{{vide.pk}}">
										<ul>
											<li class="ntipo">{{vide.tipo.nome}}</li>
											<li class="bullet">&#8226;</li>
										 <li class="npublicacao" title="{% trans 'Data de Criação'%}">{{vide.created|date:"d M Y"}}</li>
										</ul>
										<div class="ntitulo">Citado em: </div>
										<div class="ntexto">
												{% if dpt.is_relative_auto_insert %}
													<a href="{%url 'compilacao' vide.dispositivo_base.dispositivo_pai.norma.pk%}#{{vide.dispositivo_base.dispositivo_pai.pk }}">{{ vide.dispositivo_base.dispositivo_pai}}</a>
												{% else %}
													<a href="{%url 'compilacao' vide.dispositivo_base.norma.pk%}#{{vide.dispositivo_base.pk }}">{{ vide.dispositivo_base}}</a>
												{% endif %}
												{% if vide.texto %} - {{vide.texto}}{% endif %}
										</div>
									</li>

								{% endfor %}
							{% endif %}


					{%if notas and dpt.pk in notas and dpt.pk in cita or dpt.pk in citado and notas%}<li class="bullet">&#8226;</li>{%endif%}

					{% if notas and dpt.pk in notas %}

						{% for nota in dpt.notas.all %}

							{% if user.is_superuser or nota.publicidade == nota.NPUBL or nota.publicidade == nota.NINST and user.is_authenticated or nota.publicidade = nota.NPRIV and nota.owner == user %}
								{%if not forloop.first %}<li class="bullet">&#8226;</li>{%endif%}
								<li class="dnli" id="nt{{nota.pk}}">
									<ul>
										{% if user.is_authenticated %}
											{% if user == nota.owner and perms.compilacao.change_nota or user.is_superuser%}
												<li><a class="btn-action btn-nota-edit"  model="nota" pk="{{nota.pk}}">Editar</a></li>
												<li class="bullet">&#8226;</li>
											{% endif %}
											{% if user == nota.owner and perms.compilacao.delete_nota or user.is_superuser %}
												<li><a class="btn-action btn-nota-delete"  model="nota" pk="{{nota.pk}}">Excluir</a></li>
												<li class="bullet">&#8226;</li>
											{% endif %}
										{% endif %}
										<li class="ntipo">{{nota.tipo.nome}}</li>
										<li class="bullet">&#8226;</li>
										<li class="nowner" title="{% trans 'Criado Por' %}">{%if nota.owner.first_name%}{{nota.owner.first_name}}{%else%}{{nota.owner}}{%endif%}</li>
										<li class="bullet">&#8226;</li>
										<li class="npublicacao" title="{% trans 'Data de Publicação'%}">{{nota.publicacao|date:"d M Y"}}</li>
									</ul>

									{%if nota.titulo %}
										<div class="ntitulo">
											{%if nota.url_externa %}<a target="_blank" href="{{nota.url_externa}}">{%endif%}
												{{nota.titulo}} -
											{%if nota.url_externa %}</a>{%endif%}
										</div>
									{%endif%}

									<div class="ntexto">
									{%if nota.url_externa %}<a target="_blank" href="{{nota.url_externa}}">{%endif%}
										{{ nota.texto}}
										{%if nota.url_externa %}</a>{%endif%}
									</div>

		{%comment%}
									<ul>
										<li class="nefetividade" title="{% trans 'Data de Efetividade'%}">{{nota.efetividade|date:"d M Y"}}</li>
										<li class="bullet">&#8226;</li>
										<li class="npublicidade">{{nota.get_publicidade_display}}</li>
									</ul>
		{%endcomment%}
								</li>
							{% endif %}



						{% endfor %}
					{% endif %}
				</ul>
			</div>
		{% endif%}
	</div>
	{% endspaceless %}
	{% if view.is_norma_alteradora and dpt.tipo_dispositivo.class_css == 'bloco_alteracao'%}
		{%with node=dpt template_name='compilacao/index_bloco_alteracao.html' %}
			{%include template_name%}
		{%endwith%}
	{% endif%}
	{% set_nivel_old view dpt.nivel %}
{% endfor %}
{% if view|isinst:'DispositivoView' %}
	{% close_div view.flag_nivel_old view.flag_nivel_ini -1 %}
{% else %}
	{% close_div view.flag_nivel_old view.flag_nivel_ini 0 %}
{% endif%}
